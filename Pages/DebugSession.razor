@page "/debug-session"
@inject EyeHospitalPOS.Helper.LoginManager LoginManager
@inject Microsoft.AspNetCore.Http.IHttpContextAccessor HttpContextAccessor

<h3>Session Debug Page</h3>

<div class="card">
    <div class="card-body">
        <h5>LoginManager Status</h5>
        <table class="table">
            <tr>
                <td><strong>IsLoggedIn:</strong></td>
                <td><code>@LoginManager.IsLoggedIn</code></td>
            </tr>
            <tr>
                <td><strong>CurrentUser:</strong></td>
                <td><code>@(LoginManager.CurrentUser?.UserName ?? "NULL")</code></td>
            </tr>
            <tr>
                <td><strong>User Role:</strong></td>
                <td><code>@(LoginManager.CurrentUser?.Role?.Name ?? "NULL")</code></td>
            </tr>
            <tr>
                <td><strong>AuthToken:</strong></td>
                <td><code>@(string.IsNullOrEmpty(LoginManager.AuthToken) ? "NULL" : $"{LoginManager.AuthToken.Substring(0, Math.Min(20, LoginManager.AuthToken.Length))}...")</code></td>
            </tr>
        </table>

        <h5 class="mt-4">HTTP Session Data</h5>
        <table class="table">
            <tr>
                <td><strong>Session Available:</strong></td>
                <td><code>@(HttpContextAccessor.HttpContext?.Session?.IsAvailable ?? false)</code></td>
            </tr>
            <tr>
                <td><strong>Session ID:</strong></td>
                <td><code>@(HttpContextAccessor.HttpContext?.Session?.Id ?? "NULL")</code></td>
            </tr>
            <tr>
                <td><strong>User in Session:</strong></td>
                <td><code>@sessionUserData</code></td>
            </tr>
        </table>

        <div class="mt-3">
            <button class="btn btn-primary" @onclick="ReloadSession">Reload Session</button>
            <button class="btn btn-secondary" @onclick="GoToDashboard">Go to Dashboard</button>
        </div>
    </div>
</div>

@code {
    [Inject] private NavigationManager Navigation { get; set; }
    private string sessionUserData = "";

    protected override async Task OnInitializedAsync()
    {
        await LoginManager.InitializeAsync();
        
        try
        {
            var session = HttpContextAccessor.HttpContext?.Session;
            if (session != null && session.IsAvailable)
            {
                sessionUserData = session.GetString("currentUser") ?? "NULL";
                if (sessionUserData != "NULL")
                {
                    sessionUserData = $"Length: {sessionUserData.Length} chars";
                }
            }
            else
            {
                sessionUserData = "Session not available";
            }
        }
        catch (Exception ex)
        {
            sessionUserData = $"Error: {ex.Message}";
        }
    }

    private async Task ReloadSession()
    {
        await OnInitializedAsync();
        StateHasChanged();
    }

    private void GoToDashboard()
    {
        Navigation.NavigateTo("/dashboard");
    }
}
