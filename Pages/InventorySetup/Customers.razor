@page "/customer"
@using EyeHospitalPOS.Models
@using EyeHospitalPOS.Helper
@using EyeHospitalPOS.Data
@using Microsoft.EntityFrameworkCore
@inject ApplicationDbContext DbContext
@inject LoginManager LoginManager
@inject NavigationManager Navigation

<PageTitle>Customers - Eye Hospital POS</PageTitle>

@if (LoginManager.CurrentUser == null)
{
    <div class="alert alert-warning m-4">Please login to access this page.</div>
}
else
{
    <div class="page-container p-4">
        <!-- Unified Header -->
        <div class="d-flex justify-content-between align-items-center mb-4">
             <div>
                <h3 class="mb-1 fw-bold">Customers</h3>
                <p class="text-muted tiny mb-0">Manage your patient and customer database</p>
             </div>
             <DxButton Text="Add New Customer"
                       RenderStyle="ButtonRenderStyle.Primary"
                       IconCssClass="fa-solid fa-plus"
                       CssClass="premium-btn"
                       Click="@(() => Navigation.NavigateTo("/customers/new"))" />
        </div>

        <div class="premium-card overflow-hidden">
             <!-- Unified Search & Filter Toolbar -->
             <div class="d-flex justify-content-between align-items-center p-3 border-bottom bg-light">
                  <div class="d-flex align-items-center flex-grow-1">
                        <div class="search-box-wrapper d-flex align-items-center bg-white border rounded px-3 me-3" style="height: 40px; min-width: 320px;">
                            <span class="fa-solid fa-magnifying-glass text-muted me-2"></span>
                            <input type="text" @bind-value="SearchText" @bind-value:event="oninput" 
                                   placeholder="Search by name, phone or ID..." 
                                   class="border-0 w-100 bg-transparent" style="outline: none; font-size: 0.9rem;" />
                        </div>
                  </div>
                  
                  <div class="filter-group d-flex align-items-center">
                        <span class="text-muted me-2 tiny fw-bold text-uppercase">Status</span>
                        <select class="form-select form-select-sm" @bind="StatusFilter" style="width: 140px; border-radius: 8px;">
                            <option value="All">All Status</option>
                            <option value="Active">Active Only</option>
                            <option value="Inactive">Inactive Only</option>
                        </select>
                  </div>
             </div>

            <div class="card-body p-0">
                @if (showError)
                {
                    <div class="alert alert-danger mx-3 mt-3">@errorMessage</div>
                }

                <DxGrid Data="@FilteredCustomers"
                        ShowFilterRow="false"
                        PageSize="20"
                        CssClass="enterprise-grid"
                        RowClick="OnRowClick">
                    <Columns>
                        <DxGridDataColumn FieldName="DisplayName" Caption="Customer Name" MinWidth="200" />
                        <DxGridDataColumn FieldName="Phone" Caption="Phone" Width="150px" />
                        <DxGridDataColumn FieldName="IsActive" Caption="Status" Width="120px" HeaderCssClass="text-center" CssClass="text-center">
                            <CellDisplayTemplate>
                                <span class='trend-badge @((bool)context.Value ? "positive" : "negative")' style="min-width: 70px; justify-content: center;">
                                    @((bool)context.Value ? "Active" : "Inactive")
                                </span>
                            </CellDisplayTemplate>
                        </DxGridDataColumn>
                        <DxGridDataColumn FieldName="ShowInSelectionList" Caption="Visible" Width="100px" HeaderCssClass="text-center" CssClass="text-center">
                            <CellDisplayTemplate>
                                <span class='tiny fw-bold @((bool)context.Value ? "text-primary" : "text-muted")'>
                                    <i class='fa-solid @((bool)context.Value ? "fa-check-circle" : "fa-circle-xmark") me-1'></i>
                                    @((bool)context.Value ? "YES" : "NO")
                                </span>
                            </CellDisplayTemplate>
                        </DxGridDataColumn>
                        <DxGridDataColumn Caption="Actions" Width="80px" TextAlignment="GridTextAlignment.Center">
                            <CellDisplayTemplate>
                                <DxButton IconCssClass="fa-solid fa-edit"
                                          RenderStyle="ButtonRenderStyle.Secondary"
                                          SizeMode="SizeMode.Small"
                                          RenderStyleMode="ButtonRenderStyleMode.Outline"
                                          Click="@(() => EditCustomer((Customer)context.DataItem))" />
                            </CellDisplayTemplate>
                        </DxGridDataColumn>
                        <DxGridDataColumn Caption="Status" Width="120px" TextAlignment="GridTextAlignment.Center">
                            <CellDisplayTemplate>
                                @{
                                    var customer = (Customer)context.DataItem;
                                    var isActive = customer.IsActive;
                                }
                                <DxButton IconCssClass="@(isActive ? "fa-solid fa-toggle-on text-success" : "fa-solid fa-toggle-off text-muted")"
                                          RenderStyle="@(isActive ? ButtonRenderStyle.Success : ButtonRenderStyle.Secondary)"
                                          SizeMode="SizeMode.Small"
                                          RenderStyleMode="ButtonRenderStyleMode.Outline"
                                          Click="@(async () => await ToggleCustomerStatus(customer))"
                                          ToolTip="@(isActive ? "Deactivate Customer" : "Activate Customer")" />
                            </CellDisplayTemplate>
                        </DxGridDataColumn>
                    </Columns>
                </DxGrid>
            </div>
        </div>
    </div>
}



@code {
    private List<Customer> customers = new List<Customer>();
    private bool showError = false;
    private string errorMessage = string.Empty;
    private string SearchText { get; set; } = string.Empty;
    private string StatusFilter { get; set; } = "All";

    private IEnumerable<Customer> FilteredCustomers => customers
        .Where(c => (string.IsNullOrEmpty(SearchText) || 
                    (c.FirstName?.Contains(SearchText, StringComparison.OrdinalIgnoreCase) ?? false) || 
                    (c.LastName?.Contains(SearchText, StringComparison.OrdinalIgnoreCase) ?? false) || 
                    (c.DisplayName?.Contains(SearchText, StringComparison.OrdinalIgnoreCase) ?? false) || 
                    (c.Phone?.Contains(SearchText) ?? false)) &&
                    (StatusFilter == "All" || 
                     (StatusFilter == "Active" && c.IsActive) ||
                     (StatusFilter == "Inactive" && !c.IsActive)));

    protected override async Task OnInitializedAsync()
    {
        if (LoginManager.CurrentUser == null)
        {
            Navigation.NavigateTo("/login");
            return;
        }

        await LoadCustomers();
    }

    private async Task LoadCustomers()
    {
        customers = await DbContext.Customers.OrderByDescending(c => c.Id).ToListAsync();
    }

    private void OnRowClick(GridRowClickEventArgs e)
    {
        var customer = (Customer)e.Grid.GetDataItem(e.VisibleIndex);
        Navigation.NavigateTo($"/customers/{customer.Id}");
    }

    private void EditCustomer(Customer customer)
    {
        Navigation.NavigateTo($"/customers/{customer.Id}");
    }

    private async Task ToggleCustomerStatus(Customer customer)
    {
        customer.IsActive = !customer.IsActive;
        DbContext.Customers.Update(customer);
        await DbContext.SaveChangesAsync();
        
        // Refresh the customer list
        await LoadCustomers();
        StateHasChanged();
    }
}
