@page "/product-categories"
@using EyeHospitalPOS.Models
@using EyeHospitalPOS.Helper
@using EyeHospitalPOS.Data
@using Microsoft.EntityFrameworkCore
@inject ApplicationDbContext DbContext
@inject LoginManager LoginManager
@inject NavigationManager Navigation

<PageTitle>Categories - EyeCare POS</PageTitle>

@if (LoginManager.CurrentUser == null)
{
    <div class="alert alert-warning m-4">Please login to access this page.</div>
}
else
{
    <div class="page-container p-4">
        <!-- Unified Header -->
        <div class="d-flex justify-content-between align-items-center mb-4">
             <div>
                <h3 class="mb-1 fw-bold">Product Categories</h3>
                <p class="text-muted tiny mb-0">Organize your inventory with logical groupings</p>
             </div>
             <DxButton Text="Add New Category"
                       RenderStyle="ButtonRenderStyle.Primary"
                       IconCssClass="fa-solid fa-plus"
                       CssClass="premium-btn"
                       Click="@(() => Navigation.NavigateTo("/product-categories/new"))" />
        </div>

        <div class="premium-card overflow-hidden">
            <div class="card-body p-0">
                <DxGrid Data="@categories"
                        ShowFilterRow="false"
                        ShowSearchBox="true"
                        PageSize="20"
                        CssClass="enterprise-grid"
                        RowClick="OnRowClick">
                    <Columns>
                        <DxGridDataColumn FieldName="Name" Caption="Category Name" MinWidth="250">
                            <CellDisplayTemplate>
                                <div class="d-flex align-items-center">
                                    <div class="bg-light rounded p-2 me-3" style="width: 38px; height: 38px; display: flex; align-items: center; justify-content: center;">
                                        <i class="fa-solid fa-layer-group text-primary"></i>
                                    </div>
                                    <span class="fw-bold">@context.Value</span>
                                </div>
                            </CellDisplayTemplate>
                        </DxGridDataColumn>
                        <DxGridDataColumn FieldName="Code" Caption="Code" Width="100px" />
                        <DxGridDataColumn FieldName="ParentCategory.Name" Caption="Parent Category" Width="200px" />
                        <DxGridDataColumn FieldName="IsActive" Caption="Status" Width="100px" HeaderCssClass="text-center" CssClass="text-center">
                            <CellDisplayTemplate>
                                <span class='trend-badge @((bool)context.Value ? "positive" : "negative")' style="min-width: 70px; justify-content: center;">
                                    @((bool)context.Value ? "Active" : "Inactive")
                                </span>
                            </CellDisplayTemplate>
                        </DxGridDataColumn>
                         <DxGridDataColumn FieldName="ShowInSelectionList" Caption="Visible" Width="80px" HeaderCssClass="text-center" CssClass="text-center">
                            <CellDisplayTemplate>
                                @if ((bool)context.Value)
                                {
                                    <i class="fa-solid fa-check text-success"></i>
                                }
                            </CellDisplayTemplate>
                        </DxGridDataColumn>
                    </Columns>
                </DxGrid>
            </div>
        </div>
    </div>
}

@code {
    private List<ProductCategory> categories = new List<ProductCategory>();

    protected override async Task OnInitializedAsync()
    {
        if (LoginManager.CurrentUser == null)
        {
            Navigation.NavigateTo("/login");
            return;
        }

        await LoadCategories();
    }

    private async Task LoadCategories()
    {
        categories = await DbContext.ProductCategories
            .Include(c => c.ParentCategory)
            .OrderBy(c => c.Name)
            .ToListAsync();
    }

    private void OnRowClick(GridRowClickEventArgs e)
    {
        var category = (ProductCategory)e.Grid.GetDataItem(e.VisibleIndex);
        Navigation.NavigateTo($"/product-categories/{category.Id}");
    }
}

