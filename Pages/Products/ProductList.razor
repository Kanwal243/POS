@page "/product"
@using EyeHospitalPOS.Controllers
@using EyeHospitalPOS.Models
@using EyeHospitalPOS.Helper
@using EyeHospitalPOS.Data
@using Microsoft.EntityFrameworkCore
@inject ApplicationDbContext DbContext
@inject ProductController ProductController
@inject LoginManager LoginManager
@inject NavigationManager Navigation

<PageTitle>Products - Eye Hospital POS</PageTitle>

@if (LoginManager.CurrentUser == null)
{
    <div class="alert alert-warning m-4">Please login to access this page.</div>
}
else
{
    <div class="page-container p-4">
        <!-- Unified Header -->
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h3 class="mb-1 fw-bold">Products</h3>
                <p class="text-muted tiny mb-0">Manage your ophthalmic inventory and pricing</p>
            </div>
            <div class="d-flex gap-2">
                <DxButton Text="Scan Barcode"
                          RenderStyle="ButtonRenderStyle.Secondary"
                          IconCssClass="fa-solid fa-barcode"
                          CssClass="premium-btn"
                          Click="@OnScanBarcodeClick" />
                <DxButton Text="Add New Product"
                          RenderStyle="ButtonRenderStyle.Primary"
                          IconCssClass="fa-solid fa-plus"
                          CssClass="premium-btn"
                          Click="@OnAddNewClick" />
            </div>
        </div>

        <!-- Barcode Scanner Modal -->
        @if (showBarcodeScanner)
        {
            <div class="modal-backdrop fade show" style="display: block; background-color: rgba(0,0,0,0.5);"></div>
            <div class="modal fade show" style="display: block;" role="dialog">
                <div class="modal-dialog modal-lg">
                    <div class="modal-content border-0">
                        <div class="modal-header bg-primary text-white border-0">
                            <h5 class="modal-title">
                                <i class="fa-solid fa-barcode me-2"></i>Scan Product Barcode
                            </h5>
                            <button type="button" class="btn-close btn-close-white" @onclick="() => showBarcodeScanner = false"></button>
                        </div>
                        <div class="modal-body p-4">
                            <div class="mb-3">
                                <label class="form-label fw-bold">Barcode/QR Code Scanner</label>
                                <input type="text"
                                       @ref="barcodeInputRef"
                                       @bind-value="scannedBarcode"
                                       @onkeyup="OnBarcodeScanned"
                                       placeholder="Place cursor here and scan barcode..."
                                       class="form-control form-control-lg"
                                       autofocus
                                       style="font-size: 1rem;" />
                                <small class="text-muted d-block mt-2">
                                    <i class="fa-solid fa-circle-info me-1"></i>Ensure the scanner field is active and ready to capture input
                                </small>
                            </div>

                            @if (barcodeSearchResult != null)
                            {
                                <div class="alert alert-success mb-3">
                                    <h6 class="mb-2"><i class="fa-solid fa-check-circle me-2"></i>Product Found</h6>
                                    <div class="row g-3 mt-2">
                                        <div class="col-md-6">
                                            <small class="text-muted d-block">Product Name</small>
                                            <strong>@barcodeSearchResult.Name</strong>
                                        </div>
                                        <div class="col-md-6">
                                            <small class="text-muted d-block">Barcode</small>
                                            <strong>@barcodeSearchResult.Barcode</strong>
                                        </div>
                                        <div class="col-md-6">
                                            <small class="text-muted d-block">Stock Quantity</small>
                                            <strong class="@(barcodeSearchResult.StockQuantity < 10 ? "text-danger" : "text-success")">@barcodeSearchResult.StockQuantity units</strong>
                                        </div>
                                        <div class="col-md-6">
                                            <small class="text-muted d-block">Sale Price</small>
                                            <strong>@($"{currencySymbol} {barcodeSearchResult.SalePrice.ToString("N2")}")</strong>
                                        </div>
                                    </div>
                                </div>
                            }
                            else if (!string.IsNullOrEmpty(scannedBarcode) && barcodeSearchError)
                            {
                                <div class="alert alert-warning mb-3">
                                    <i class="fa-solid fa-triangle-exclamation me-2"></i>No product found with barcode: <strong>@scannedBarcode</strong>
                                </div>
                            }
                        </div>
                        <div class="modal-footer border-0">
                            <button type="button" class="btn btn-secondary" @onclick="() => { showBarcodeScanner = false; scannedBarcode = string.Empty; barcodeSearchResult = null; }">Close</button>
                            @if (barcodeSearchResult != null)
                            {
                                <button type="button" class="btn btn-primary" @onclick="() => EditScannedProduct(barcodeSearchResult.Id)">Edit Product</button>
                            }
                        </div>
                    </div>
                </div>
            </div>
        }

        <div class="premium-card overflow-hidden">
            <!-- Unified Search & Filter Toolbar -->
            <div class="d-flex justify-content-between align-items-center p-3 border-bottom bg-light">
                <div class="d-flex align-items-center flex-grow-1">
                    <div class="search-box-wrapper d-flex align-items-center bg-white border rounded px-3 me-3" style="height: 40px; min-width: 320px;">
                        <span class="fa-solid fa-magnifying-glass text-muted me-2"></span>
                        <input type="text" @bind-value="SearchText" @bind-value:event="oninput"
                               placeholder="Search by name or barcode..."
                               class="border-0 w-100 bg-transparent" style="outline: none; font-size: 0.9rem;" />
                    </div>
                </div>

                <div class="filter-group d-flex align-items-center">
                    <span class="text-muted me-2 tiny fw-bold text-uppercase">Status</span>
                    <select class="form-select form-select-sm" @bind="StatusFilter" style="width: 140px; border-radius: 8px;">
                        <option value="All">All Status</option>
                        <option value="Active">Active Only</option>
                        <option value="Inactive">Inactive Only</option>
                    </select>
                </div>
            </div>

            <div class="card-body p-0">
                @if (showError)
                {
                    <div class="alert alert-danger mx-3 mt-3">@errorMessage</div>
                }

                <DxGrid @ref="Grid"
                        Data="@FilteredProducts"
                        ShowFilterRow="false"
                        PageSize="20"
                        CssClass="enterprise-grid"
                        EditMode="GridEditMode.PopupEditForm"
                        PopupEditFormHeaderText="Product Information"
                        EditModelSaving="OnEditModelSaving"
                        DataItemDeleting="OnDataItemDeleting">
                    <Columns>
                        <DxGridCommandColumn Width="120px" />
                        <DxGridDataColumn FieldName="Name" Caption="Product Name" MinWidth="150">
                            <CellDisplayTemplate>
                                <div class="d-flex align-items-center">
                               @*      <div class="bg-light rounded p-2 me-3" style="width: 38px; height: 38px; display: flex; align-items: center; justify-content: center;">
                                        <i class="fa-solid fa-box-open text-primary"></i>
                                    </div> *@
                                    <span class="fw-bold">@context.Value</span>
                                </div>
                            </CellDisplayTemplate>
                        </DxGridDataColumn>
                        <DxGridDataColumn FieldName="Barcode" Caption="Barcode" Width="120px" />
                        <DxGridDataColumn FieldName="Category.Name" Caption="Category" Width="150px" />
                        <DxGridDataColumn FieldName="Type.Name" Caption="Type" Width="120px" />
                        <DxGridDataColumn FieldName="CostPrice" Caption="Cost" Width="100px">
                            <CellDisplayTemplate>
                                 <span>@($"{currencySymbol} {((decimal)context.Value).ToString("N2")}")</span>
                            </CellDisplayTemplate>
                        </DxGridDataColumn>
                        <DxGridDataColumn FieldName="SalePrice" Caption="Price" Width="100px">
                            <CellDisplayTemplate>
                                 <span>@($"{currencySymbol} {((decimal)context.Value).ToString("N2")}")</span>
                            </CellDisplayTemplate>
                        </DxGridDataColumn>
                        <DxGridDataColumn FieldName="StockQuantity" Caption="Stock" Width="100px" HeaderCssClass="text-center" CssClass="text-center">
                            <CellDisplayTemplate>
                                <span class='fw-bold @((int)context.Value < 10 ? "text-danger" : "text-dark")'>
                                    @context.Value
                                </span>
                            </CellDisplayTemplate>
                        </DxGridDataColumn>
                        <DxGridDataColumn FieldName="IsActive" Caption="Status" Width="120px" HeaderCssClass="text-center" CssClass="text-center">
                            <CellDisplayTemplate>
                                <span class='trend-badge @((bool)context.Value ? "positive" : "negative")' style="min-width: 70px; justify-content: center;">
                                    @((bool)context.Value ? "Active" : "Inactive")
                                </span>
                            </CellDisplayTemplate>
                        </DxGridDataColumn>
                    </Columns>
                    <EditFormTemplate Context="EditContext">
                        @{
                            var product = (Product)EditContext.EditModel;
                            currentEditingProduct = product; // Store reference for barcode scanning
                        }
                        <div class="p-4 bg-white">
                            <div class="mb-4 border-bottom pb-2">
                                <h5 class="mb-0 fw-bold" style="color: var(--primary-color);">
                                    <i class="fa-solid fa-box-open me-2"></i>Product Details
                                </h5>
                            </div>

                            <div class="row g-4">
                                <!-- Barcode Scanner Input -->
                                <div class="col-12">
                                    <div class="alert alert-info d-flex align-items-center mb-3">
                                        <i class="fa-solid fa-barcode me-2"></i>
                                        <div class="flex-grow-1">
                                            <strong>Scan Barcode:</strong>
                                            <input type="text"
                                                   @ref="formBarcodeInputRef"
                                                   @bind-value="formScannedBarcode"
                                                   @onkeyup="OnFormBarcodeScanned"
                                                   placeholder="Scan or type barcode to auto-fill product data..."
                                                   class="form-control mt-2"
                                                   autocomplete="off" />
                                            <small class="text-muted d-block mt-1">
                                                <i class="fa-solid fa-lightbulb me-1"></i>Use a barcode scanner or type manually. Product data will be automatically filled.
                                            </small>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label tiny fw-bold text-uppercase text-muted">Product Name</label>
                                    <DxTextBox @bind-Text="@product.Name" Width="100%" />
                                </div>
                                <div class="col-md-6">
                                    <div class="d-flex justify-content-between align-items-center mb-2">
                                        <label class="form-label tiny fw-bold text-uppercase text-muted mb-0">Barcode</label>
                                        <button type="button" class="btn btn-link btn-sm p-0 text-primary" @onclick="() => GenerateBarcodePreview(product.Barcode)">
                                            <i class="fa-solid fa-qrcode me-1"></i>Preview
                                        </button>
                                    </div>
                                    <DxTextBox @bind-Text="@product.Barcode" Width="100%" />
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label tiny fw-bold text-uppercase text-muted">Category</label>
                                    <DxComboBox Data="@categories"
                                                @bind-Value="@product.CategoryId"
                                                ValueFieldName="Id"
                                                TextFieldName="Name"
                                                Width="100%" />
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label tiny fw-bold text-uppercase text-muted">Type</label>
                                    <DxComboBox Data="@types"
                                                @bind-Value="@product.TypeId"
                                                ValueFieldName="Id"
                                                TextFieldName="Name"
                                                Width="100%" />
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label tiny fw-bold text-uppercase text-muted">Supplier</label>
                                    <DxComboBox Data="@suppliers"
                                                @bind-Value="@product.SupplierId"
                                                ValueFieldName="Id"
                                                TextFieldName="Name"
                                                Width="100%" />
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label tiny fw-bold text-uppercase text-muted">Cost Price</label>
                                    <DxSpinEdit @bind-Value="@product.CostPrice" DisplayFormat="@($"{currencySymbol} #,0.00")" Width="100%" />
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label tiny fw-bold text-uppercase text-muted">Sale Price</label>
                                    <DxSpinEdit @bind-Value="@product.SalePrice" DisplayFormat="@($"{currencySymbol} #,0.00")" Width="100%" />
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label tiny fw-bold text-uppercase text-muted">Stock Quantity</label>
                                    <DxSpinEdit @bind-Value="@product.StockQuantity" Width="100%" />
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label tiny fw-bold text-uppercase text-muted">Reorder Level</label>
                                    <DxSpinEdit @bind-Value="@product.ReorderLevel" Width="100%" />
                                </div>
                                <div class="col-12 mt-4 pt-3 border-top">
                                    <DxCheckBox @bind-Checked="@product.IsActive">
                                        <span class="tiny fw-bold text-muted">Active Product Status</span>
                                    </DxCheckBox>
                                </div>
                            </div>
                        </div>
                    </EditFormTemplate>
                </DxGrid>
            </div>
        </div>

    </div>
}

@code {
    private List<Product> products = new List<Product>();
    private List<ProductCategory> categories = new List<ProductCategory>();
    private List<ProductType> types = new List<ProductType>();
    private List<Supplier> suppliers = new List<Supplier>();
    private IGrid Grid { get; set; }
    private bool showError = false;
    private string errorMessage = string.Empty;
    private string SearchText { get; set; } = string.Empty;
    private string StatusFilter { get; set; } = "All";
    private string currencySymbol = "PKR";

    // Barcode scanner variables
    private bool showBarcodeScanner = false;
    private string scannedBarcode = string.Empty;
    private Product barcodeSearchResult = null;
    private bool barcodeSearchError = false;
    private ElementReference barcodeInputRef;

    // Form barcode scanner variables
    private string formScannedBarcode = string.Empty;
    private ElementReference formBarcodeInputRef;
    private Product? currentEditingProduct = null;

    private IEnumerable<Product> FilteredProducts => products
        .Where(p => (string.IsNullOrEmpty(SearchText) ||
                    (p.Name?.Contains(SearchText, StringComparison.OrdinalIgnoreCase) ?? false) ||
                    (p.Barcode?.Contains(SearchText) ?? false)) &&
                    (StatusFilter == "All" ||
                     (StatusFilter == "Active" && p.IsActive) ||
                     (StatusFilter == "Inactive" && !p.IsActive)));

    protected override async Task OnInitializedAsync()
    {
        if (LoginManager.CurrentUser == null)
        {
            Navigation.NavigateTo("/login");
            return;
        }

        await LoadProducts();
        await LoadLookupData();
        await LoadOrganizationSettings();
    }

    private async Task LoadOrganizationSettings()
    {
        var org = await DbContext.Organizations.FirstOrDefaultAsync();
        currencySymbol = CurrencyHelper.GetCurrencySymbol(org);
    }

    private async Task LoadProducts()
    {
        products = await DbContext.Products
            .Include(p => p.Category)
            .Include(p => p.Type)
            .Include(p => p.Supplier)
            .OrderByDescending(p => p.Id)
            .ToListAsync();
    }

    private async Task LoadLookupData()
    {
        categories = await DbContext.ProductCategories.ToListAsync();
        types = await DbContext.ProductTypes.ToListAsync();
        suppliers = await DbContext.Suppliers.ToListAsync();
    }

    private async Task OnAddNewClick()
    {
        await Grid.StartEditNewRowAsync();
    }

    private void OnScanBarcodeClick()
    {
        showBarcodeScanner = true;
        scannedBarcode = string.Empty;
        barcodeSearchResult = null;
        barcodeSearchError = false;
    }

    private async Task OnBarcodeScanned(KeyboardEventArgs e)
    {
        if (e.Key == "Enter" && !string.IsNullOrEmpty(scannedBarcode))
        {
            var product = products.FirstOrDefault(p => p.Barcode.Equals(scannedBarcode.Trim(), StringComparison.OrdinalIgnoreCase));

            if (product != null)
            {
                barcodeSearchResult = product;
                barcodeSearchError = false;
                scannedBarcode = string.Empty;
                // Auto-fill and open edit form
                await FillProductFormAndEdit(product);
                showBarcodeScanner = false;
                await barcodeInputRef.FocusAsync();
            }
            else
            {
                barcodeSearchError = true;
                barcodeSearchResult = null;
                scannedBarcode = string.Empty;
                await barcodeInputRef.FocusAsync();
            }
        }
    }

    private async Task OnFormBarcodeScanned(KeyboardEventArgs e)
    {
        if (e.Key == "Enter" && !string.IsNullOrEmpty(formScannedBarcode))
        {
            var barcodeText = formScannedBarcode.Trim();
            var foundProduct = products.FirstOrDefault(p => p.Barcode.Equals(barcodeText, StringComparison.OrdinalIgnoreCase));

            if (foundProduct != null && currentEditingProduct != null)
            {
                // Fill the form with product data
                currentEditingProduct.Name = foundProduct.Name;
                currentEditingProduct.Barcode = foundProduct.Barcode;
                currentEditingProduct.CategoryId = foundProduct.CategoryId;
                currentEditingProduct.TypeId = foundProduct.TypeId;
                currentEditingProduct.SupplierId = foundProduct.SupplierId;
                currentEditingProduct.CostPrice = foundProduct.CostPrice;
                currentEditingProduct.SalePrice = foundProduct.SalePrice;
                currentEditingProduct.StockQuantity = foundProduct.StockQuantity;
                currentEditingProduct.ReorderLevel = foundProduct.ReorderLevel;
                currentEditingProduct.IsActive = foundProduct.IsActive;

                // Clear the scanner input
                formScannedBarcode = string.Empty;
                await formBarcodeInputRef.FocusAsync();
                StateHasChanged();
            }
            else if (currentEditingProduct != null)
            {
                // Product not found - just set the barcode field
                currentEditingProduct.Barcode = barcodeText;
                formScannedBarcode = string.Empty;
                await formBarcodeInputRef.FocusAsync();
                StateHasChanged();
            }
        }
    }

    private async Task FillProductFormAndEdit(Product product)
    {
        if (product != null)
        {
            showBarcodeScanner = false;
            scannedBarcode = string.Empty;
            barcodeSearchResult = null;

            // Start editing the product
            await Grid.StartEditRowAsync(product.Id);
            StateHasChanged();
        }
    }

    private async Task EditScannedProduct(int productId)
    {
        await FillProductFormAndEdit(products.FirstOrDefault(p => p.Id == productId));
    }

    private void GenerateBarcodePreview(string barcode)
    {
        if (string.IsNullOrEmpty(barcode))
        {
            errorMessage = "Please enter a barcode value first";
            showError = true;
        }
        else
        {
            showError = false;
        }
    }

    private async Task OnEditModelSaving(GridEditModelSavingEventArgs e)
    {
        try
        {
            var editModel = (Product)e.EditModel;
            var dataItem = (Product)e.DataItem;

            if (string.IsNullOrWhiteSpace(editModel.Name))
            {
                errorMessage = "Product name is required";
                showError = true;
                e.Cancel = true;
                return;
            }

            if (editModel.CategoryId <= 0)
            {
                errorMessage = "Category is required";
                showError = true;
                e.Cancel = true;
                return;
            }

            if (editModel.TypeId <= 0)
            {
                errorMessage = "Type is required";
                showError = true;
                e.Cancel = true;
                return;
            }

            if (editModel.SupplierId <= 0)
            {
                errorMessage = "Supplier is required";
                showError = true;
                e.Cancel = true;
                return;
            }

            if (e.IsNew)
            {
                await DbContext.Products.AddAsync(editModel);
            }
            else
            {
                DbContext.Entry(dataItem).CurrentValues.SetValues(editModel);
            }

            await DbContext.SaveChangesAsync();
            await LoadProducts();
            showError = false;
        }
        catch (Exception ex)
        {
            var innerMessage = ex.InnerException?.Message ?? "";
            errorMessage = $"Error saving product: {ex.Message} \nDetails: {innerMessage}";
            showError = true;
            e.Cancel = true;
        }
    }

    private async Task OnDataItemDeleting(GridDataItemDeletingEventArgs e)
    {
        try
        {
            var dataItem = (Product)e.DataItem;
            DbContext.Products.Remove(dataItem);
            await DbContext.SaveChangesAsync();
            await LoadProducts();
            showError = false;
        }
        catch (Exception ex)
        {
            errorMessage = "Error deleting product: " + ex.Message;
            showError = true;
            e.Cancel = true;
        }
    }
}


