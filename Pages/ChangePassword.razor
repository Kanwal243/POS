@page "/change-password"
@layout EyeHospitalPOS.Shared.EmptyLayout
@using EyeHospitalPOS.Services
@using EyeHospitalPOS.Helper
@inject IAuthService AuthService
@inject LoginManager LoginManager
@inject NavigationManager Navigation
@inject IJSRuntime JSRuntime

<div class="login-wrapper">
    <!-- Theme Toggle -->
    <div class="theme-toggle-wrapper">
        <label class="theme-switcher">
            <input type="checkbox" checked="@isDarkMode" @onchange="ToggleTheme" />
            <span class="slider">
                <span class="icon sun">
                    <i class="fa-solid fa-sun"></i>
                </span>
                <span class="icon moon">
                    <i class="fa-solid fa-moon"></i>
                </span>
            </span>
        </label>
    </div>

    <div class="login-container">
        <!-- Left Side: Change Password Form -->
        <div class="login-form-section">
            <div class="form-content">
                <div class="mb-4">
                    <h2 class="auth-title">Security Check</h2>
                    <p class="auth-subtitle">For security reasons, you must change your password regarding your first login.</p>
                </div>

                @if (!string.IsNullOrEmpty(errorMessage))
                {
                    <div class="alert alert-danger mb-4" role="alert">
                        @errorMessage
                    </div>
                }

                <div class="form-group mb-3">
                    <label class="form-label">New Password</label>
                    <div class="input-group-custom">
                         <span class="input-icon fa-solid fa-lock"></span>
                         <input type="password" class="form-control-custom" 
                                @bind-value="newPassword" 
                                placeholder="Enter new password" />
                    </div>
                </div>

                <div class="form-group mb-4">
                    <label class="form-label">Confirm Password</label>
                    <div class="input-group-custom">
                         <span class="input-icon fa-solid fa-lock"></span>
                         <input type="password" class="form-control-custom" 
                                @bind-value="confirmPassword" 
                                placeholder="Confirm new password" />
                    </div>
                </div>

                <button class="btn btn-primary btn-block w-100 sign-in-btn" @onclick="HandleSubmit" disabled="@isProcessing">
                    @if (isProcessing)
                    {
                        <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
                        <span>Updating...</span>
                    }
                    else
                    {
                        <span>Update Password</span>
                    }
                </button>
                
                <div class="mt-4 text-center">
                     <button class="btn btn-link text-muted" style="text-decoration:none;" @onclick="Logout">Cancel & Logout</button>
                </div>
            </div>
        </div>

        <!-- Right Side: Branding -->
        <div class="branding-section">
            <div class="branding-content text-center">
@*                 <h2 class="brand-title">Al-Ibrahim Eye Hospital</h2>
 *@                <h4 class="brand-subtitle mb-3" style="color: #cbd5e1; font-weight: 500;">Point of Sale System</h4>
                <p class="brand-description">
                    Streamline your patient care and operations.
                </p>
            </div>
        </div>
    </div>
</div>

<style>
    .form-content {
        max-width: 400px;
        margin: 0 auto;
        width: 100%;
    }

    .input-group-custom {
        position: relative;
    }

    .input-icon {
        position: absolute;
        left: 15px;
        top: 50%;
        transform: translateY(-50%);
        color: #94a3b8;
        font-size: 1.1rem;
        z-index: 10;
    }

    .sign-in-btn {
        background-color: #3c50e0;
        border-color: #3c50e0;
        padding: 0.75rem;
        font-weight: 600;
        border-radius: 8px;
        transition: background-color 0.2s;
    }

    .branding-content {
        position: relative;
        z-index: 2;
    }

    .brand-description {
        font-size: 1.1rem;
        color: #cbd5e1;
        line-height: 1.6;
    }

    @@media (max-width: 991.98px) {
        .login-container {
            flex-direction: column;
            max-width: 500px;
            min-height: auto;
        }

        .branding-section {
            display: none;
        }
    }

    /* TailAdmin Style Theme Toggle */
    .theme-toggle-wrapper {
        position: absolute;
        top: 30px;
        right: 30px;
        z-index: 100;
    }

    .theme-switcher {
        position: relative;
        display: inline-block;
        width: 64px;
        height: 32px;
    }

    .theme-switcher input {
        opacity: 0;
        width: 0;
        height: 0;
    }

    .slider {
        position: absolute;
        cursor: pointer;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: #E2E8F0;
        transition: .4s;
        border-radius: 34px;
        display: flex;
        align-items: center;
        padding: 0 4px;
    }

    [data-theme='dark'] .slider {
        background-color: #313D4A;
    }

    .slider:before {
        position: absolute;
        content: "";
        height: 24px;
        width: 24px;
        left: 4px;
        bottom: 4px;
        background-color: white;
        transition: .4s;
        border-radius: 50%;
        z-index: 2;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    input:checked + .slider:before {
        transform: translateX(32px);
    }

    .icon {
        flex: 1;
        text-align: center;
        font-size: 14px;
        z-index: 1;
        transition: .4s;
    }

    .sun {
        color: #FACC15;
    }

    .moon {
        color: #94A3B8;
    }

    [data-theme='dark'] .sun {
        color: #64748B;
    }

    [data-theme='dark'] .moon {
        color: #F1F5F9;
    }
</style>

@code {
    private bool isDarkMode = false;
    private string newPassword = "";
    private string confirmPassword = "";
    private string errorMessage = "";
    private bool isProcessing = false;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            var theme = await JSRuntime.InvokeAsync<string>("getTheme");
            isDarkMode = theme == "dark";
            StateHasChanged();
        }
    }

    private async Task ToggleTheme()
    {
        isDarkMode = !isDarkMode;
        await JSRuntime.InvokeVoidAsync("setTheme", isDarkMode ? "dark" : "light");
    }

    protected override void OnInitialized()
    {
        if (LoginManager.CurrentUser == null)
        {
            Navigation.NavigateTo("/login");
        }
    }

    private async Task HandleSubmit()
    {
        if (isProcessing) return;

        errorMessage = "";
        
        if (string.IsNullOrWhiteSpace(newPassword))
        {
            errorMessage = "Password cannot be empty.";
            return;
        }

        if (newPassword != confirmPassword)
        {
            errorMessage = "Passwords do not match.";
            return;
        }

        // Simpistic complexity check
        if (newPassword.Length < 6)
        {
            errorMessage = "Password must be at least 6 characters long.";
            return;
        }

        try
        {
            isProcessing = true;
            StateHasChanged();

            var changePasswordDto = new EyeHospitalPOS.Models.DTOs.ChangePasswordDto
            {
                CurrentPassword = "", // Not required for force change
                NewPassword = newPassword,
                ConfirmPassword = confirmPassword
            };

            var success = await AuthService.ChangePasswordAsync(LoginManager.CurrentUser!.Id, changePasswordDto);
            
            if (success)
            {
                // Update local user state so they aren't redirected back here
                LoginManager.CurrentUser.ChangePasswordOnLogin = false;
                Navigation.NavigateTo("/");
            }
            else
            {
                errorMessage = "Failed to update password. Please try again.";
            }
        }
        catch (Exception ex)
        {
            errorMessage = "An error occurred: " + ex.Message;
        }
        finally
        {
            isProcessing = false;
            StateHasChanged();
        }
    }

    private async Task Logout()
    {
        // await LoginManager.LogoutAsync();
        // Navigation.NavigateTo("/login");
    }
}
