@page "/users/new"
@page "/users/edit/{Id}"
@using EyeHospitalPOS.Models
@using EyeHospitalPOS.Helper
@using EyeHospitalPOS.Data
@using EyeHospitalPOS.Controllers
@using Microsoft.EntityFrameworkCore
@inject ApplicationDbContext DbContext
@inject LoginManager LoginManager
@inject NavigationManager Navigation
@inject UserController UserController

@attribute [Authorize(Roles = "Administrator")]

<PageTitle>@(string.IsNullOrEmpty(Id) ? "New User" : "Edit User") - Eye Hospital POS</PageTitle>

<div class="page-container p-4">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h3 class="mb-1 fw-bold">@(string.IsNullOrEmpty(Id) ? "Create New User" : "Edit User Details")</h3>
                <p class="text-muted tiny mb-0">Manage user access, credentials, and role assignments</p>
            </div>
            <div class="toolbar-actions">
                <DxButton RenderStyle="ButtonRenderStyle.Secondary" 
                          IconCssClass="fa-solid fa-arrow-left" 
                          SizeMode="SizeMode.Small"
                          CssClass="btn-toolbar"
                          Click="@(() => Navigation.NavigateTo("/users"))" />
                
                <DxButton Text="@(string.IsNullOrEmpty(Id) ? "Save User" : "Save Changes")" 
                          RenderStyle="ButtonRenderStyle.Success" 
                          IconCssClass="fa-solid fa-floppy-disk"
                          SizeMode="SizeMode.Small"
                          CssClass="btn-toolbar"
                          Click="@HandleSave" />
            </div>
        </div>

        @if (showError)
        {
            <div class="alert alert-danger mb-4">@errorMessage</div>
        }

        <div class="row g-4">
            <!-- Form Section -->
            <div class="col-lg-8">
                <div class="premium-card h-100 shadow-sm border-0 overflow-hidden">
                    <div class="card-header premium-header p-4 border-0">
                        <h5 class="fw-bold mb-0 text-white d-flex align-items-center">
                            <i class="fa-solid fa-id-card-clip me-3 opacity-75"></i>Basic Information
                        </h5>
                    </div>
                    <div class="card-body p-4">
                        <EditForm EditContext="@editContext" OnValidSubmit="HandleValidSubmit">
                            <DataAnnotationsValidator />
                            
                            <div class="row g-4">
                                <div class="col-md-6">
                                    <div class="form-group-custom">
                                        <label class="form-label-custom">Username</label>
                                    <DxTextBox @bind-Text="@user.UserName" 
                                               ClearButtonDisplayMode="DataEditorClearButtonDisplayMode.Auto" 
                                               ReadOnly="@(!string.IsNullOrEmpty(Id))" />
                                        <ValidationMessage For="@(() => user.UserName)" />
                                        @if (!string.IsNullOrEmpty(Id)) { 
                                            <div class="tiny text-muted mt-2 d-flex align-items-center opacity-75">
                                                <i class="fa-solid fa-lock me-2"></i>Username cannot be changed
                                            </div> 
                                        }
                                    </div>
                                </div>

                                <div class="col-md-6">
                                    <div class="form-group-custom">
                                        <label class="form-label-custom">Email Address</label>
                                    <DxTextBox @bind-Text="@user.Email" 
                                               ClearButtonDisplayMode="DataEditorClearButtonDisplayMode.Auto" />
                                        <ValidationMessage For="@(() => user.Email)" />
                                    </div>
                                </div>

                                @if (string.IsNullOrEmpty(Id))
                                {
                                    <div class="col-md-6">
                                        <div class="form-group-custom">
                                            <label class="form-label-custom">Initial Password</label>
                                            <DxTextBox @bind-Text="@password" 
                                                       Password="true" 
                                                       ClearButtonDisplayMode="DataEditorClearButtonDisplayMode.Auto" />
                                            <span class="tiny text-muted mt-2 d-block">Min. 8 characters with numbers</span>
                                        </div>
                                    </div>
                                }

                                <div class="col-md-6">
                                    <div class="form-group-custom">
                                        <label class="form-label-custom">System Role</label>
                                        <DxComboBox Data="@availableRoles"
                                                    @bind-Value="@user.RoleId"
                                                    TextFieldName="Name"
                                                    ValueFieldName="Id"
                                                    AllowUserInput="false"
                                                    ClearButtonDisplayMode="DataEditorClearButtonDisplayMode.Auto" />
                                        <ValidationMessage For="@(() => user.RoleId)" />
                                    </div>
                                </div>

                            </div>
                        </EditForm>
                    </div>
                </div>
            </div>

            <!-- Settings Sidebar -->
            <div class="col-lg-4">
                <div class="premium-card mb-4 shadow-sm border-0 overflow-hidden">
                    <div class="card-header premium-header-alt p-4 border-0">
                        <h5 class="fw-bold mb-0 text-white d-flex align-items-center">
                            <i class="fa-solid fa-shield-halved me-3 opacity-75"></i>Security & Status
                        </h5>
                    </div>
                    <div class="card-body p-4">
                        <div class="status-option mb-4 p-3 rounded-3 border @(user.IsActive ? "border-success bg-light-success" : "border-danger bg-light-danger")">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <div class="fw-bold @(user.IsActive ? "text-success" : "text-danger") mb-0">Account Status</div>
                                    <div class="tiny text-muted">Toggle login availability</div>
                                </div>
                                <DxCheckBox @bind-Checked="@user.IsActive" />
                            </div>
                        </div>

                        <div class="settings-pill mb-4 p-3 rounded-3 border bg-white shadow-sm d-flex align-items-center">
                            <DxCheckBox @bind-Checked="@user.ChangePasswordOnLogin" />
                            <div class="ms-3">
                                <div class="fw-bold small">Force Password Change</div>
                                <div class="tiny text-muted">On next successful login</div>
                            </div>
                        </div>
                        
                        <div class="bg-light p-3 rounded-3 mt-4 border border-opacity-10">
                            <h6 class="tiny fw-bold text-uppercase text-muted mb-3 border-bottom pb-2">AUDIT INFO</h6>
                            <div class="d-flex justify-content-between mb-2">
                                <span class="tiny text-muted">Created:</span>
                                <span class="tiny fw-normal">@user.CreatedDate.ToString("MMM dd, yyyy")</span>
                            </div>
                            @if (user.ModifiedDate.HasValue)
                            {
                                <div class="d-flex justify-content-between">
                                    <span class="tiny text-muted">Last Updated:</span>
                                    <span class="tiny fw-normal">@user.ModifiedDate.Value.ToString("MMM dd, HH:mm")</span>
                                </div>
                            }
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

<style>
    .premium-header {
        background: linear-gradient(135deg, #4e73df 0%, #6f42c1 100%);
        border-radius: 12px 12px 0 0 !important;
    }

    .premium-header-alt {
        background: linear-gradient(135deg, #6f42c1 0%, #5a32a3 100%);
        border-radius: 12px 12px 0 0 !important;
    }

    .form-group-custom { margin-bottom: 0.5rem; }
    .form-label-custom {
        font-weight: 600;
        font-size: 0.9rem;
        color: #475569;
        margin-bottom: 0.5rem;
        display: block;
    }

    .bg-light-success { background-color: rgba(34, 197, 94, 0.08); }
    .bg-light-danger { background-color: rgba(239, 68, 68, 0.08); }
    .status-option { border-width: 2px !important; }
    .settings-pill:hover { border-color: #4e73df !important; }
</style>

@code {
    [Parameter] public string? Id { get; set; }
    
    private User user = new User { IsActive = true };
    private EditContext? editContext;
    private List<Role> availableRoles = new List<Role>();
    private string password = string.Empty;
    private bool showError = false;
    private string errorMessage = string.Empty;

    protected override void OnInitialized()
    {
        editContext = new EditContext(user);
    }

    protected override async Task OnInitializedAsync()
    {
        // Skip manual check as [Authorize] handles it.
        await LoadUser();
    }

    private async Task LoadUser()
    {
        // Load active roles for the dropdown
        availableRoles = await DbContext.Roles.AsNoTracking().Where(r => r.IsActive).ToListAsync();

        if (!string.IsNullOrEmpty(Id))
        {
            // Load user for editing
            var existingUser = await UserController.GetUserByIdAsync(Id);
            if (existingUser != null)
            {
                user = existingUser;
                editContext = new EditContext(user);
            }
            else
            {
                errorMessage = "User not found.";
                showError = true;
            }
        }
    }

    private async Task HandleSave()
    {
        if (editContext != null && editContext.Validate())
        {
            await HandleValidSubmit();
        }
    }

    private async Task HandleValidSubmit()
    {
        try
        {
            showError = false;
            if (string.IsNullOrEmpty(user.RoleId))
            {
                errorMessage = "Please select a system role.";
                showError = true;
                return;
            }

            if (string.IsNullOrEmpty(user.Id))
            {
                // Create New
                if (string.IsNullOrEmpty(password))
                {
                    errorMessage = "Password is required for new users.";
                    showError = true;
                    return;
                }
                
                user.Id = Guid.NewGuid().ToString();
                await UserController.CreateUserAsync(user, password);
            }
            else
            {
                // Update Existing
                await UserController.UpdateUserAsync(user);
            }

            Navigation.NavigateTo("/users");
        }
        catch (Exception ex)
        {
            errorMessage = $"Error saving user: {ex.Message} {(ex.InnerException != null ? ex.InnerException.Message : "")}";
            showError = true;
        }
    }
}
