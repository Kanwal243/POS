@page "/roles"
@using EyeHospitalPOS.Models
@using EyeHospitalPOS.Helper
@using EyeHospitalPOS.Data
@using Microsoft.EntityFrameworkCore
@inject ApplicationDbContext DbContext
@inject LoginManager LoginManager
@inject NavigationManager Navigation

@attribute [Authorize(Roles = "Administrator,Manager")]

<PageTitle>Roles & Permissions - Eye Hospital POS</PageTitle>

<div class="page-container p-4">
        <!-- Unified Header -->
        <div class="d-flex justify-content-between align-items-center mb-4">
             <div>
                <h3 class="mb-1 fw-bold">Roles & Permissions Management</h3>
                <p class="text-muted tiny mb-0">Manage roles, permissions, and user access</p>
             </div>
             <div class="d-flex gap-2">
                 <div class="d-flex align-items-center me-3">
                     <DxCheckBox Checked="@showInactiveRoles" 
                                 CheckedChanged="@(async (bool val) => { showInactiveRoles = val; await LoadRoles(); })" />
                     <span class="ms-2 tiny text-muted">Show Deactivated</span>
                 </div>
                 <DxButton Text="New Role"
                           RenderStyle="ButtonRenderStyle.Primary"
                           IconCssClass="fa-solid fa-plus"
                           CssClass="premium-btn"
                           Click="@(() => Navigation.NavigateTo("/roles/new"))" />
             </div>
        </div>

        @if (showError)
        {
            <div class="alert alert-danger mb-4">@errorMessage</div>
        }

        @if (showSuccess)
        {
            <div class="alert alert-success mb-4">@successMessage</div>
        }

        <!-- Tabs -->
        <DxTabs @bind-ActiveTabIndex="@ActiveTabIndex" CssClass="mb-3">
            <DxTabPage Text="Roles">
                <div class="premium-card overflow-hidden">
                    <div class="card-body p-0">
                        <DxGrid @ref="Grid"
                                Data="@roles"
                                KeyFieldName="Id"
                                ShowFilterRow="false"
                                ShowSearchBox="true"
                                PageSize="20"
                                CssClass="enterprise-grid"
                                DataItemDeleting="OnDataItemDeleting">
                            <Columns>
                                <DxGridDataColumn FieldName="Name" Caption="Role Name" MinWidth="200" />
                                <DxGridDataColumn FieldName="Description" Caption="Description" MinWidth="250" />
                                <DxGridDataColumn FieldName="ParentRoleId" Caption="Parent Role" Width="180px">
                                    <CellDisplayTemplate>
                                        @{
                                            var role = (Role)context.DataItem;
                                            var parentRole = roles.FirstOrDefault(r => r.Id == role.ParentRoleId);
                                        }
                                        @if (parentRole != null)
                                        {
                                            <span class="tiny" style="display: inline-block; padding: 0.25rem 0.5rem; border-radius: 12px; background-color: var(--info-bg); color: var(--info-color); font-weight: 600;">@parentRole.Name</span>
                                        }
                                        else
                                        {
                                            <span class="text-muted tiny">No Parent</span>
                                        }
                                    </CellDisplayTemplate>
                                </DxGridDataColumn>
                                <DxGridDataColumn FieldName="IsAdministrative" Caption="Administrative" Width="120px" HeaderCssClass="text-center" CssClass="text-center">
                                    <CellDisplayTemplate>
                                        <span class='trend-badge @((bool)context.Value ? "positive" : "neutral")' style="width: 100px; justify-content: center;">
                                            @((bool)context.Value ? "FULL ACCESS" : "LIMITED")
                                        </span>
                                    </CellDisplayTemplate>
                                </DxGridDataColumn>
                                <DxGridDataColumn FieldName="CanEditModel" Caption="Can Edit Data" Width="120px" HeaderCssClass="text-center" CssClass="text-center">
                                    <CellDisplayTemplate>
                                        <i class='fa-solid @((bool)context.Value ? "fa-circle-check text-success" : "fa-circle-xmark text-muted")'></i>
                                    </CellDisplayTemplate>
                                </DxGridDataColumn>
                                <DxGridDataColumn FieldName="IsActive" Caption="Status" Width="100px" HeaderCssClass="text-center" CssClass="text-center">
                                    <CellDisplayTemplate>
                                        <span class='trend-badge @((bool)context.Value ? "positive" : "negative")' style="width: 80px; justify-content: center;">
                                            @((bool)context.Value ? "ACTIVE" : "INACTIVE")
                                        </span>
                                    </CellDisplayTemplate>
                                </DxGridDataColumn>
                                 <DxGridDataColumn Caption="Actions" Width="280px" TextAlignment="GridTextAlignment.Center">
                                    <CellDisplayTemplate>
                                        <div class="d-flex gap-2 justify-content-center">
                                             <DxButton Text="Edit"
                                                       RenderStyle="ButtonRenderStyle.Secondary" 
                                                       IconCssClass="fa-solid fa-pen-to-square"
                                                       SizeMode="SizeMode.Small"
                                                       CssClass="px-2"
                                                       Click="@(() => Navigation.NavigateTo($"/roles/edit/{(context.DataItem as Role).Id}"))" />
                                            <DxButton Text="Pages"
                                                      RenderStyle="ButtonRenderStyle.Info"
                                                      IconCssClass="fa-solid fa-file-shield"
                                                      SizeMode="SizeMode.Small"
                                                      CssClass="px-2"
                                                      Click="@(async () => {
                                                          var role = (Role)context.DataItem;
                                                          selectedRole = role;
                                                          await LoadPagePermissionsForRole(role);
                                                          ShowPagePermissionsModal = true;
                                                      })" />
                                            <DxButton Text="Perms"
                                                      RenderStyle="ButtonRenderStyle.Warning"
                                                      IconCssClass="fa-solid fa-key"
                                                      SizeMode="SizeMode.Small"
                                                      CssClass="px-2"
                                                      Click="@(async () => {
                                                          var role = (Role)context.DataItem;
                                                          selectedRole = role;
                                                          await LoadPermissionsForRole(role);
                                                          ShowPermissionsModal = true;
                                                      })" />
                                             <DxButton RenderStyle="ButtonRenderStyle.Danger" 
                                                       IconCssClass="fa-solid fa-trash"
                                                       SizeMode="SizeMode.Small"
                                                       Click="@(() => Grid.ShowDataItemDeleteConfirmation(context.DataItem))" />
                                        </div>
                                    </CellDisplayTemplate>
                                </DxGridDataColumn>
                            </Columns>
                        </DxGrid>
                    </div>
                </div>
            </DxTabPage>

            <DxTabPage Text="Child Roles">
                <div class="premium-card">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <div>
                                <h5 class="mb-1">Role Hierarchy</h5>
                                <p class="text-muted mb-0">View and manage parent-child role relationships</p>
                            </div>
                            <DxButton Text="Refresh Hierarchy" 
                                      RenderStyle="ButtonRenderStyle.Secondary" 
                                      IconCssClass="fa-solid fa-rotate" 
                                      SizeMode="SizeMode.Small"
                                      Click="@LoadRoles" />
                        </div>
                        
                        @{
                            RenderFragment<Role> RenderRoleNode = null;
                            RenderRoleNode = (role) => 
                            @<text>
                                <div class="role-node mb-2">
                                    <div class="d-flex align-items-center">
                                        @if(role.ParentRoleId == null)
                                        {
                                             <i class="fa-solid fa-crown text-warning me-2"></i>
                                             <strong style="color: var(--text-main);">@role.Name</strong>
                                             <span class="ms-2 tiny" style="display: inline-block; padding: 0.25rem 0.5rem; border-radius: 12px; background-color: var(--primary-color); color: white; font-weight: 600;">Root</span>
                                        }
                                        else
                                        {
                                             <i class="fa-solid fa-turn-up fa-rotate-90 text-muted me-2 tiny"></i>
                                             <span style="color: var(--text-main);">@role.Name</span>
                                        }
                                        
                                        <div class="ms-auto opacity-50 hover-opacity-100">
                                            <a href="/roles/edit/@role.Id" class="text-muted ms-2" style="text-decoration: none;" title="Edit Role">
                                                <i class="fa-solid fa-pen-to-square"></i>
                                            </a>
                                        </div>
                                    </div>
                                    
                                    @{
                                        var children = roles.Where(r => r.ParentRoleId == role.Id).ToList();
                                        if(children.Any())
                                        {
                                            <div class="ms-4 ps-3 mt-2" style="border-left: 2px solid var(--border-color);">
                                                @foreach(var child in children)
                                                {
                                                    @RenderRoleNode(child)
                                                }
                                            </div>
                                        }
                                    }
                                </div>
                            </text>;
                        }

                        <div class="role-tree mt-4">
                            @if (roles.Any())
                            {
                                var rootRoles = roles.Where(r => r.ParentRoleId == null).ToList();
                                if (rootRoles.Any())
                                {
                                    @foreach (var parentRole in rootRoles)
                                    {
                                        <div class="mb-3 pb-3" style="border-bottom: 1px solid var(--border-color);">
                                            @RenderRoleNode(parentRole)
                                        </div>
                                    }
                                }
                                else
                                {
                                    <div class="p-3 rounded" style="background-color: var(--warning-bg); border: 1px solid var(--border-color); color: var(--warning-color);">
                                        <i class="fa-solid fa-triangle-exclamation me-2"></i>
                                        No root roles found. All roles seem to have parents (Circular dependency or missing parent).
                                    </div>
                                }
                                
                                var orphanedRoles = roles.Where(r => r.ParentRoleId != null && !roles.Any(parent => parent.Id == r.ParentRoleId)).ToList();
                                if (orphanedRoles.Any())
                                {
                                     <div class="mt-4 pt-3 p-3 rounded" style="border-top: 1px solid var(--border-color); background-color: var(--bg-hover);">
                                         <h6 class="text-danger fw-bold"><i class="fa-solid fa-link-slash me-2"></i>Orphaned Roles</h6>
                                         <p class="tiny text-muted">These roles point to a parent that does not exist.</p>
                                         @foreach(var orphan in orphanedRoles)
                                         {
                                             <div class="d-flex align-items-center mb-1">
                                                 <i class="fa-solid fa-circle-exclamation text-danger me-2 tiny"></i>
                                                 <span style="color: var(--text-main);">@orphan.Name</span>
                                             </div>
                                         }
                                     </div>
                                }
                            }
                            else
                            {
                                <div class="text-center p-5 text-muted">
                                    <i class="fa-solid fa-folder-tree h1 mb-3 opacity-25"></i>
                                    <p>No roles defined yet.</p>
                                </div>
                            }
                        </div>
                    </div>
                </div>
            </DxTabPage>

            <DxTabPage Text="User Access">
                <div class="premium-card">
                    <div class="card-body">
                        <h5 class="mb-3">Assign Roles to Users</h5>
                        <p class="text-muted mb-4">Manage user role assignments</p>
                        
                        <DxGrid Data="@users"
                                KeyFieldName="Id"
                                ShowFilterRow="false"
                                ShowSearchBox="true"
                                PageSize="15"
                                CssClass="enterprise-grid">
                            <Columns>
                                <DxGridDataColumn FieldName="UserName" Caption="Username" MinWidth="150" />
                                <DxGridDataColumn FieldName="Email" Caption="Email" MinWidth="200" />
                                <DxGridDataColumn FieldName="RoleId" Caption="Current Role" Width="200px">
                                    <CellDisplayTemplate>
                                        @{
                                            var user = (User)context.DataItem;
                                            var userRole = roles.FirstOrDefault(r => r.Id == user.RoleId);
                                        }
                                        @if (userRole != null)
                                        {
                                            <span style="display: inline-block; padding: 0.25rem 0.5rem; border-radius: 12px; background-color: var(--success-bg); color: var(--success-color); font-weight: 600; font-size: 0.75rem;">@userRole.Name</span>
                                        }
                                        else
                                        {
                                            <span class="text-muted">No Role</span>
                                        }
                                    </CellDisplayTemplate>
                                </DxGridDataColumn>
                                <DxGridDataColumn FieldName="IsActive" Caption="Status" Width="100px" HeaderCssClass="text-center" CssClass="text-center">
                                    <CellDisplayTemplate>
                                        <span class="tiny" style="display: inline-block; padding: 0.25rem 0.5rem; border-radius: 12px; font-weight: 600; @((bool)context.Value ? "background-color: var(--success-bg); color: var(--success-color);" : "background-color: var(--danger-bg); color: var(--danger-color);")">
                                            @((bool)context.Value ? "Active" : "Inactive")
                                        </span>
                                    </CellDisplayTemplate>
                                </DxGridDataColumn>
                                <DxGridDataColumn Caption="Actions" Width="150px" TextAlignment="GridTextAlignment.Center">
                                    <CellDisplayTemplate>
                                        <DxButton Text="Assign Role"
                                                  RenderStyle="ButtonRenderStyle.Primary"
                                                  IconCssClass="fa-solid fa-user-tag"
                                                  SizeMode="SizeMode.Small"
                                                  Click="@(() => {
                                                      selectedUser = (User)context.DataItem;
                                                      selectedRoleIdForUser = selectedUser.RoleId;
                                                      ShowUserRoleModal = true;
                                                  })" />
                                    </CellDisplayTemplate>
                                </DxGridDataColumn>
                            </Columns>
                        </DxGrid>
                    </div>
                </div>
            </DxTabPage>
        </DxTabs>
    </div>

    <!-- Page Permissions Modal -->
    <DxPopup @bind-Visible="@ShowPagePermissionsModal"
             HeaderText="@($"Page Permissions for {selectedRole?.Name}")"
             Width="900px"
             Height="700px"
             ShowCloseButton="true">
        <BodyContentTemplate>
            <div class="p-3">
                @if (selectedRole != null && pagePermissions.Any())
                {
                    <div class="table-responsive">
                        <table class="table table-hover table-sm">
                            <thead class="table-light">
                                <tr>
                                    <th>Page/Object</th>
                                    <th class="text-center">Read</th>
                                    <th class="text-center">Write</th>
                                    <th class="text-center">Create</th>
                                    <th class="text-center">Delete</th>
                                    <th class="text-center">Navigate</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var module in pagePermissions.GroupBy(p => p.Module))
                                {
                                    <tr class="table-secondary">
                                        <td colspan="6"><strong><i class="fa-solid fa-folder me-2"></i>@module.Key</strong></td>
                                    </tr>
                                    @foreach (var page in module)
                                    {
                                        <tr>
                                            <td>@(page.PageName)</td>
                                            <td class="text-center">
                                                <DxCheckBox @bind-Checked="@GetOrCreateRolePagePermission(page.Id).CanRead" />
                                            </td>
                                            <td class="text-center">
                                                <DxCheckBox @bind-Checked="@GetOrCreateRolePagePermission(page.Id).CanWrite" />
                                            </td>
                                            <td class="text-center">
                                                <DxCheckBox @bind-Checked="@GetOrCreateRolePagePermission(page.Id).CanCreate" />
                                            </td>
                                            <td class="text-center">
                                                <DxCheckBox @bind-Checked="@GetOrCreateRolePagePermission(page.Id).CanDelete" />
                                            </td>
                                            <td class="text-center">
                                                <DxCheckBox @bind-Checked="@GetOrCreateRolePagePermission(page.Id).CanNavigate" />
                                            </td>
                                        </tr>
                                    }
                                }
                            </tbody>
                        </table>
                    </div>
                }
            </div>
        </BodyContentTemplate>
        <FooterTemplate>
             <div class="d-flex justify-content-between p-3 w-100" style="border-top: 1px solid var(--border-color); background-color: var(--bg-hover);">
                <DxButton Text="Close" RenderStyle="ButtonRenderStyle.Secondary" Click="@(() => ShowPagePermissionsModal = false)" />
                <DxButton Text="Save Page Permissions" RenderStyle="ButtonRenderStyle.Primary" IconCssClass="fa-solid fa-check" Click="@SavePagePermissions" />
            </div>
        </FooterTemplate>
    </DxPopup>

    <!-- Module Permissions Modal -->
    <DxPopup @bind-Visible="@ShowPermissionsModal"
             HeaderText="@($"Module Permissions for {selectedRole?.Name}")"
             Width="800px"
             Height="600px"
             ShowCloseButton="true">
        <BodyContentTemplate>
            <div class="p-3">
                @if (selectedRole != null)
                {
                    <DxFormLayout Data="@permissionModel" ItemSpacing="10px" CaptionPosition="CaptionPosition.Vertical" Context="formContext">
                        <DxFormLayoutGroup ColSpanLg="12">
                            <!-- POS Permissions -->
                            <DxFormLayoutItem Caption="POS & Sales Actions" ColSpanLg="12" Context="itemContext">
                                <div class="p-3 rounded mb-3" style="border: 1px solid var(--border-color); background-color: var(--bg-hover);">
                                    <h6 class="pb-2 mb-3 fw-bold text-primary" style="border-bottom: 1px solid var(--border-color);"><i class="fa-solid fa-cash-register me-2"></i>Point of Sale</h6>
                                    <div class="row g-3">
                                        <div class="col-md-4"><DxCheckBox @bind-Checked="@permissionModel.CanAccessPOS">Access POS</DxCheckBox></div>
                                        <div class="col-md-4"><DxCheckBox @bind-Checked="@permissionModel.CanProcessSales">Process Sales</DxCheckBox></div>
                                        <div class="col-md-4"><DxCheckBox @bind-Checked="@permissionModel.CanVoidSales">Void Transactions</DxCheckBox></div>
                                        <div class="col-md-4"><DxCheckBox @bind-Checked="@permissionModel.CanRefundSales">Process Refunds</DxCheckBox></div>
                                        <div class="col-md-4"><DxCheckBox @bind-Checked="@permissionModel.CanEditPrices">Edit Prices</DxCheckBox></div>
                                        <div class="col-md-4"><DxCheckBox @bind-Checked="@permissionModel.CanOverrideDiscounts">Override Discounts</DxCheckBox></div>
                                    </div>
                                </div>
                            </DxFormLayoutItem>
                            
                            <!-- Inventory Permissions -->
                            <DxFormLayoutItem Caption="Inventory Management" ColSpanLg="12" Context="itemContext">
                                <div class="p-3 rounded mb-3" style="border: 1px solid var(--border-color); background-color: var(--bg-hover);">
                                    <h6 class="pb-2 mb-3 fw-bold text-success" style="border-bottom: 1px solid var(--border-color);"><i class="fa-solid fa-boxes-stacked me-2"></i>Inventory</h6>
                                    <div class="row g-3">
                                        <div class="col-md-4"><DxCheckBox @bind-Checked="@permissionModel.CanAccessInventory">Access Inventory</DxCheckBox></div>
                                        <div class="col-md-4"><DxCheckBox @bind-Checked="@permissionModel.CanReceiveInventory">Receive Stock</DxCheckBox></div>
                                        <div class="col-md-4"><DxCheckBox @bind-Checked="@permissionModel.CanCreatePurchaseOrders">Create POs</DxCheckBox></div>
                                        <div class="col-md-4"><DxCheckBox @bind-Checked="@permissionModel.CanAdjustInventory">Adjust Stock</DxCheckBox></div>
                                        <div class="col-md-4"><DxCheckBox @bind-Checked="@permissionModel.CanViewInventoryReports">View Reports</DxCheckBox></div>
                                        <div class="col-md-4"><DxCheckBox @bind-Checked="@permissionModel.CanEditInventory">Manage Items</DxCheckBox></div>
                                    </div>
                                </div>
                            </DxFormLayoutItem>
                            
                            <!-- System Permissions -->
                            <DxFormLayoutItem Caption="System Administration" ColSpanLg="12" Context="itemContext">
                                <div class="p-3 rounded mb-3" style="border: 1px solid var(--border-color); background-color: var(--bg-hover);">
                                    <h6 class="pb-2 mb-3 fw-bold text-danger" style="border-bottom: 1px solid var(--border-color);"><i class="fa-solid fa-gears me-2"></i>System</h6>
                                    <div class="row g-3">
                                        <div class="col-md-4"><DxCheckBox @bind-Checked="@permissionModel.CanManageUsers">Manage Users</DxCheckBox></div>
                                        <div class="col-md-4"><DxCheckBox @bind-Checked="@permissionModel.CanManageRoles">Manage Roles</DxCheckBox></div>
                                        <div class="col-md-4"><DxCheckBox @bind-Checked="@permissionModel.CanViewSystemReports">View Analytics</DxCheckBox></div>
                                        <div class="col-md-4"><DxCheckBox @bind-Checked="@permissionModel.CanManageSuppliers">Manage Suppliers</DxCheckBox></div>
                                    </div>
                                </div>
                            </DxFormLayoutItem>
                        </DxFormLayoutGroup>
                    </DxFormLayout>
                }
            </div>
        </BodyContentTemplate>
        <FooterTemplate>
             <div class="d-flex justify-content-between p-3 w-100" style="border-top: 1px solid var(--border-color); background-color: var(--bg-hover);">
                <DxButton Text="Close" RenderStyle="ButtonRenderStyle.Secondary" Click="@(() => ShowPermissionsModal = false)" />
                <DxButton Text="Save Module Permissions" RenderStyle="ButtonRenderStyle.Primary" IconCssClass="fa-solid fa-check" Click="@SavePermissions" />
            </div>
        </FooterTemplate>
    </DxPopup>

    <!-- User Role Assignment Modal -->
    <DxPopup @bind-Visible="@ShowUserRoleModal"
             HeaderText="@($"Assign Role to {selectedUser?.UserName}")"
             Width="500px"
             ShowCloseButton="true">
        <BodyContentTemplate>
            <div class="p-3">
                @if (selectedUser != null)
                {
                    <DxFormLayout>
                        <DxFormLayoutItem Caption="Username" ColSpanLg="12">
                            <Template Context="usernameContext">
                                <strong>@selectedUser.UserName</strong>
                            </Template>
                        </DxFormLayoutItem>
                        <DxFormLayoutItem Caption="Email" ColSpanLg="12">
                            <Template Context="emailContext">
                                @selectedUser.Email
                            </Template>
                        </DxFormLayoutItem>
                        <DxFormLayoutItem Caption="Select Role" ColSpanLg="12">
                            <Template Context="roleContext">
                                <DxComboBox Data="@roles.Where(r => r.IsActive)"
                                            @bind-Value="@selectedRoleIdForUser"
                                            TextFieldName="Name"
                                            ValueFieldName="Id"
                                            AllowUserInput="false"
                                            ClearButtonDisplayMode="DataEditorClearButtonDisplayMode.Auto">
                                </DxComboBox>
                            </Template>
                        </DxFormLayoutItem>
                    </DxFormLayout>
                }
            </div>
        </BodyContentTemplate>
        <FooterTemplate>
             <div class="d-flex justify-content-between p-3 w-100" style="border-top: 1px solid var(--border-color); background-color: var(--bg-hover);">
                <DxButton Text="Cancel" RenderStyle="ButtonRenderStyle.Secondary" Click="@(() => ShowUserRoleModal = false)" />
                <DxButton Text="Assign Role" RenderStyle="ButtonRenderStyle.Primary" IconCssClass="fa-solid fa-check" Click="@AssignRoleToUser" />
            </div>
        </FooterTemplate>
    </DxPopup>

@code {
    private List<Role> roles = new List<Role>();
    private List<User> users = new List<User>();
    private List<PagePermission> pagePermissions = new List<PagePermission>();
    private List<RolePagePermission> rolePagePermissions = new List<RolePagePermission>();
    
    private DxGrid Grid { get; set; }
    private bool showError = false;
    private bool showSuccess = false;
    private string errorMessage = string.Empty;
    private string successMessage = string.Empty;
    
    private bool ShowPermissionsModal = false;
    private bool ShowPagePermissionsModal = false;
    private bool ShowUserRoleModal = false;
    
    private Role? selectedRole = null;
    private User? selectedUser = null;
    private string selectedRoleIdForUser = string.Empty;
    
    private PermissionModel permissionModel = new();
    private int ActiveTabIndex = 0;

    protected override async Task OnInitializedAsync()
    {

        await LoadData();
    }

    private async Task LoadData()
    {
        try
        {
            await LoadRoles();
            await LoadUsers();
            await LoadPagePermissions();
        }
        catch (Exception ex)
        {
            errorMessage = "Error loading data: " + ex.Message;
            showError = true;
        }
    }

    private bool showInactiveRoles = false;

    private async Task LoadRoles()
    {
        var query = DbContext.Roles
            .Include(r => r.RolePermissions)
            .Include(r => r.RolePagePermissions)
            .AsNoTracking();

        if (!showInactiveRoles)
        {
            query = query.Where(r => r.IsActive);
        }

        roles = await query.ToListAsync();
    }

    private async Task LoadUsers()
    {
        users = await DbContext.Users
            .Include(u => u.Role)
            .AsNoTracking()
            .ToListAsync();
    }

    private async Task LoadPagePermissions()
    {
        pagePermissions = await DbContext.PagePermissions
            .Where(p => p.IsActive)
            .OrderBy(p => p.Module)
            .ThenBy(p => p.PageName)
            .AsNoTracking()
            .ToListAsync();
    }

    private async Task OnDataItemDeleting(GridDataItemDeletingEventArgs e)
    {
        try
        {
            var dataItem = (Role)e.DataItem;
            
            if (dataItem == null)
            {
                errorMessage = "Role data is invalid.";
                showError = true;
                showSuccess = false;
                e.Cancel = true;
                return;
            }
            
            // Perform checks with AsNoTracking to avoid adding them to context
            var usersInRole = await DbContext.Users.AsNoTracking().AnyAsync(u => u.RoleId == dataItem.Id);
            if (usersInRole)
            {
                errorMessage = "Cannot delete role because it is assigned to users.";
                showError = true;
                showSuccess = false;
                e.Cancel = true;
                return;
            }

            var hasChildRoles = await DbContext.Roles.AsNoTracking().AnyAsync(r => r.ParentRoleId == dataItem.Id);
            if (hasChildRoles)
            {
                errorMessage = "Cannot delete role because it has child roles.";
                showError = true;
                showSuccess = false;
                e.Cancel = true;
                return;
            }

            // Safely handle tracking conflicts for soft deletion
            var trackedRole = await DbContext.Roles.FindAsync(dataItem.Id);
            if (trackedRole != null)
            {
                trackedRole.IsActive = false; // Soft delete
                await DbContext.SaveChangesAsync();
                
                // Clear the context's state for this item to prevent downstream tracking issues
                DbContext.Entry(trackedRole).State = EntityState.Detached;

                await LoadRoles();
                showError = false;
                showSuccess = true;
                successMessage = "Role deactivated successfully!";
            }
            else
            {
                errorMessage = "Role not found.";
                showError = true;
                showSuccess = false;
                e.Cancel = true;
            }
        }
        catch (Exception ex)
        {
            errorMessage = "Error deleting role: " + ex.Message;
            showError = true;
            showSuccess = false;
            e.Cancel = true;
        }
    }

    private async Task LoadPermissionsForRole(Role role)
    {
        if (role == null) return;

        try
        {
            // Load existing permissions for the role
            var rolePermissions = await DbContext.RolePermissions
                .Where(rp => rp.RoleId == role.Id)
                .ToListAsync();

            // Map to permission model
            permissionModel = new PermissionModel
            {
                CanAccessPOS = rolePermissions.Any(rp => rp.PermissionName == "POS.Access"),
                CanProcessSales = rolePermissions.Any(rp => rp.PermissionName == "POS.ProcessSales"),
                CanVoidSales = rolePermissions.Any(rp => rp.PermissionName == "POS.VoidSales"),
                CanRefundSales = rolePermissions.Any(rp => rp.PermissionName == "POS.RefundSales"),
                CanEditPrices = rolePermissions.Any(rp => rp.PermissionName == "POS.EditPrices"),
                CanOverrideDiscounts = rolePermissions.Any(rp => rp.PermissionName == "POS.OverrideDiscounts"),
                CanAccessInventory = rolePermissions.Any(rp => rp.PermissionName == "Inventory.Access"),
                CanEditInventory = rolePermissions.Any(rp => rp.PermissionName == "Inventory.Edit"),
                CanReceiveInventory = rolePermissions.Any(rp => rp.PermissionName == "Inventory.Receive"),
                CanAdjustInventory = rolePermissions.Any(rp => rp.PermissionName == "Inventory.Adjust"),
                CanViewInventoryReports = rolePermissions.Any(rp => rp.PermissionName == "Inventory.ViewReports"),
                CanCreatePurchaseOrders = rolePermissions.Any(rp => rp.PermissionName == "Inventory.CreatePurchaseOrders"),
                CanAccessSales = rolePermissions.Any(rp => rp.PermissionName == "Sales.Access"),
                CanViewSalesReports = rolePermissions.Any(rp => rp.PermissionName == "Sales.ViewReports"),
                CanViewSalesHistory = rolePermissions.Any(rp => rp.PermissionName == "Sales.ViewHistory"),
                CanManageCustomers = rolePermissions.Any(rp => rp.PermissionName == "Sales.ManageCustomers"),
                CanManageUsers = rolePermissions.Any(rp => rp.PermissionName == "System.ManageUsers"),
                CanManageRoles = rolePermissions.Any(rp => rp.PermissionName == "System.ManageRoles"),
                CanManageProducts = rolePermissions.Any(rp => rp.PermissionName == "System.ManageProducts"),
                CanManageSuppliers = rolePermissions.Any(rp => rp.PermissionName == "System.ManageSuppliers"),
                CanViewSystemReports = rolePermissions.Any(rp => rp.PermissionName == "System.ViewReports")
            };
        }
        catch (Exception ex)
        {
            errorMessage = "Error loading role permissions: " + ex.Message;
            showError = true;
        }
    }

    private async Task LoadPagePermissionsForRole(Role role)
    {
        if (role == null) return;

        // Load existing page permissions for the role
        rolePagePermissions = await DbContext.RolePagePermissions
            .Where(rpp => rpp.RoleId == role.Id)
            .ToListAsync();
            
        // Ensure all page permissions are represented, even if not set
        var existingPagePermissionIds = rolePagePermissions.Select(rpp => rpp.PagePermissionId).ToHashSet();
        var allPagePermissionIds = pagePermissions.Select(pp => pp.Id).ToHashSet();
        
        // Add missing page permissions with default values
        var missingPagePermissionIds = allPagePermissionIds.Except(existingPagePermissionIds);
        foreach (var pagePermissionId in missingPagePermissionIds)
        {
            rolePagePermissions.Add(new RolePagePermission
            {
                RoleId = role.Id,
                PagePermissionId = pagePermissionId,
                CanRead = false,
                CanWrite = false,
                CanCreate = false,
                CanDelete = false,
                CanNavigate = false
            });
        }
    }

    private async Task SavePermissions()
    {
        if (selectedRole == null) return;

        try
        {
            // Get existing permissions for this role
            var existingPermissions = await DbContext.RolePermissions
                .Where(rp => rp.RoleId == selectedRole.Id)
                .ToListAsync();

            // Remove all existing permissions for this role
            DbContext.RolePermissions.RemoveRange(existingPermissions);

            // Add new permissions based on the permission model
            var newPermissions = new List<RolePermission>();

            if (permissionModel.CanAccessPOS)
                newPermissions.Add(new RolePermission { RoleId = selectedRole.Id, PermissionName = "POS.Access", Module = "POS" });
            if (permissionModel.CanProcessSales)
                newPermissions.Add(new RolePermission { RoleId = selectedRole.Id, PermissionName = "POS.ProcessSales", Module = "POS" });
            if (permissionModel.CanVoidSales)
                newPermissions.Add(new RolePermission { RoleId = selectedRole.Id, PermissionName = "POS.VoidSales", Module = "POS" });
            if (permissionModel.CanRefundSales)
                newPermissions.Add(new RolePermission { RoleId = selectedRole.Id, PermissionName = "POS.RefundSales", Module = "POS" });
            if (permissionModel.CanEditPrices)
                newPermissions.Add(new RolePermission { RoleId = selectedRole.Id, PermissionName = "POS.EditPrices", Module = "POS" });
            if (permissionModel.CanOverrideDiscounts)
                newPermissions.Add(new RolePermission { RoleId = selectedRole.Id, PermissionName = "POS.OverrideDiscounts", Module = "POS" });
            if (permissionModel.CanAccessInventory)
                newPermissions.Add(new RolePermission { RoleId = selectedRole.Id, PermissionName = "Inventory.Access", Module = "Inventory" });
            if (permissionModel.CanEditInventory)
                newPermissions.Add(new RolePermission { RoleId = selectedRole.Id, PermissionName = "Inventory.Edit", Module = "Inventory" });
            if (permissionModel.CanReceiveInventory)
                newPermissions.Add(new RolePermission { RoleId = selectedRole.Id, PermissionName = "Inventory.Receive", Module = "Inventory" });
            if (permissionModel.CanAdjustInventory)
                newPermissions.Add(new RolePermission { RoleId = selectedRole.Id, PermissionName = "Inventory.Adjust", Module = "Inventory" });
            if (permissionModel.CanViewInventoryReports)
                newPermissions.Add(new RolePermission { RoleId = selectedRole.Id, PermissionName = "Inventory.ViewReports", Module = "Inventory" });
            if (permissionModel.CanCreatePurchaseOrders)
                newPermissions.Add(new RolePermission { RoleId = selectedRole.Id, PermissionName = "Inventory.CreatePurchaseOrders", Module = "Inventory" });
            if (permissionModel.CanAccessSales)
                newPermissions.Add(new RolePermission { RoleId = selectedRole.Id, PermissionName = "Sales.Access", Module = "Sales" });
            if (permissionModel.CanViewSalesReports)
                newPermissions.Add(new RolePermission { RoleId = selectedRole.Id, PermissionName = "Sales.ViewReports", Module = "Sales" });
            if (permissionModel.CanViewSalesHistory)
                newPermissions.Add(new RolePermission { RoleId = selectedRole.Id, PermissionName = "Sales.ViewHistory", Module = "Sales" });
            if (permissionModel.CanManageCustomers)
                newPermissions.Add(new RolePermission { RoleId = selectedRole.Id, PermissionName = "Sales.ManageCustomers", Module = "Sales" });
            if (permissionModel.CanManageUsers)
                newPermissions.Add(new RolePermission { RoleId = selectedRole.Id, PermissionName = "System.ManageUsers", Module = "System" });
            if (permissionModel.CanManageRoles)
                newPermissions.Add(new RolePermission { RoleId = selectedRole.Id, PermissionName = "System.ManageRoles", Module = "System" });
            if (permissionModel.CanManageProducts)
                newPermissions.Add(new RolePermission { RoleId = selectedRole.Id, PermissionName = "System.ManageProducts", Module = "System" });
            if (permissionModel.CanManageSuppliers)
                newPermissions.Add(new RolePermission { RoleId = selectedRole.Id, PermissionName = "System.ManageSuppliers", Module = "System" });
            if (permissionModel.CanViewSystemReports)
                newPermissions.Add(new RolePermission { RoleId = selectedRole.Id, PermissionName = "System.ViewReports", Module = "System" });

            if (newPermissions.Any())
            {
                await DbContext.RolePermissions.AddRangeAsync(newPermissions);
            }

            await DbContext.SaveChangesAsync();
            
            ShowPermissionsModal = false;
            await LoadRoles();
            
            showSuccess = true;
            showError = false;
            successMessage = "Module permissions saved successfully!";
        }
        catch (Exception ex)
        {
            errorMessage = "Error saving permissions: " + ex.Message;
            showError = true;
            showSuccess = false;
        }
    }

    private async Task SavePagePermissions()
    {
        if (selectedRole == null) return;

        try
        {
            // Get existing page permissions for this role
            var existingPagePermissions = await DbContext.RolePagePermissions
                .Where(rpp => rpp.RoleId == selectedRole.Id)
                .ToListAsync();

            // Remove all existing page permissions for this role
            DbContext.RolePagePermissions.RemoveRange(existingPagePermissions);

            // Add new page permissions based on current selections
            var updatedPagePermissions = pagePermissions.Select(pp =>
            {
                var selectedPerm = rolePagePermissions.FirstOrDefault(rpp => rpp.PagePermissionId == pp.Id);
                return new RolePagePermission
                {
                    RoleId = selectedRole.Id,
                    PagePermissionId = pp.Id,
                    CanRead = selectedPerm?.CanRead ?? false,
                    CanWrite = selectedPerm?.CanWrite ?? false,
                    CanCreate = selectedPerm?.CanCreate ?? false,
                    CanDelete = selectedPerm?.CanDelete ?? false,
                    CanNavigate = selectedPerm?.CanNavigate ?? false
                };
            }).ToList();

            // Only add permissions that have at least one access type enabled
            var permissionsToSave = updatedPagePermissions
                .Where(rpp => rpp.CanRead || rpp.CanWrite || rpp.CanCreate || rpp.CanDelete || rpp.CanNavigate)
                .ToList();

            if (permissionsToSave.Any())
            {
                await DbContext.RolePagePermissions.AddRangeAsync(permissionsToSave);
            }

            await DbContext.SaveChangesAsync();
            
            ShowPagePermissionsModal = false;
            await LoadRoles();
            
            showSuccess = true;
            showError = false;
            successMessage = "Page permissions saved successfully!";
        }
        catch (Exception ex)
        {
            errorMessage = "Error saving page permissions: " + ex.Message;
            showError = true;
            showSuccess = false;
        }
    }

    private async Task AssignRoleToUser()
    {
        if (selectedUser == null || string.IsNullOrEmpty(selectedRoleIdForUser)) return;

        try
        {
            var user = await DbContext.Users.FindAsync(selectedUser.Id);
            if (user != null)
            {
                user.RoleId = selectedRoleIdForUser;
                
                // Create user role assignment record
                var assignment = new UserRoleAssignment
                {
                    UserId = user.Id,
                    RoleId = selectedRoleIdForUser,
                    AssignedBy = LoginManager.CurrentUser?.Id ?? "system",
                    AssignedDate = DateTime.Now,
                    IsActive = true
                };
                
                await DbContext.UserRoleAssignments.AddAsync(assignment);
                await DbContext.SaveChangesAsync();
                
                ShowUserRoleModal = false;
                await LoadUsers();
                
                showSuccess = true;
                showError = false;
                successMessage = $"Role assigned to {user.UserName} successfully!";
            }
            else
            {
                errorMessage = "User not found";
                showError = true;
                showSuccess = false;
            }
        }
        catch (Exception ex)
        {
            errorMessage = "Error assigning role: " + ex.Message;
            showError = true;
            showSuccess = false;
        }
    }

    private RolePagePermission GetOrCreateRolePagePermission(int pagePermissionId)
    {
        var rolePagePerm = rolePagePermissions.FirstOrDefault(rpp => rpp.PagePermissionId == pagePermissionId);
        if (rolePagePerm == null && selectedRole != null)
        {
            rolePagePerm = new RolePagePermission 
            { 
                RoleId = selectedRole.Id, 
                PagePermissionId = pagePermissionId,
                CanRead = false,
                CanWrite = false,
                CanCreate = false,
                CanDelete = false,
                CanNavigate = false
            };
            rolePagePermissions.Add(rolePagePerm);
        }
        return rolePagePerm!;
    }
}
